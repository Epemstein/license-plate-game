<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.00, maximum-scale=2.00, minimum-scale=1.00">
    <title>License Plate Game ‚Äì Time Trial</title>
    <link rel="stylesheet" href="/index.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script defer src="/index.js"></script>
</head>
<body>

<div style="display:flex;align-items:center;justify-content:space-between">
    <h1>The License Plate Game v47</h1>
    <div id="authSection">
        <div id="authPlaceholder">
            Loading...
        </div>
        <button id="signInBtn" onclick="signInWithGoogle()" style="display:none;padding:8px 16px;cursor:pointer;background:#4285f4;color:white;border:none;border-radius:4px;font-weight:600;">Sign In with Google</button>
        <div id="userInfo" style="display:none;">
            Signed in: <strong id="userName"></strong>
            <button id="signOutBtn" onclick="logout()" style="margin-left:10px;padding:4px 8px;cursor:pointer;">Sign Out</button>
        </div>
    </div>
</div>

<div style="margin-bottom:10px;display:flex;gap:10px;flex-wrap:wrap;">
    <button id="dailyChallengeBtn" class="gameModeButton" style="padding:10px 20px;background:#fbbf24;border:none;font-weight:bold;margin-right:10px;">Daily Challenge</button>
    <button id="practiceBtn" class="gameModeButton" style="padding:10px 20px;background:#e9d5ff;border:none;margin-right:10px;font-weight:bold;">Practice Mode</button>
    <button id="h2hBtn" class="gameModeButton" style="padding:10px 20px;background:#a60000ff;color:white;border:none;margin-right:10px;font-weight:bold;">
        <span>Head-to-head</span>
        <span id="h2hNotificationBadge" style="display:none;position:absolute;top:8px;right:8px;background:#ef4444;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;line-height:20px;text-align:center;font-weight:600;"></span>
    </button>
    <button id="endlessBtn" class="gameModeButton" style="padding:10px 20px;background:#cae4ffff;border:none;margin-right:10px;font-weight:bold;">Endless Mode</button>
    <button id="rulesBtn" style="padding:10px 20px;background:#e5e7eb;border:none;font-weight:bold;">How to Play</button>
</div>
<div id="modeIndicator" style="padding:8px;background:#f3f4f6;border-radius:4px;margin-bottom:10px;font-weight:600;text-align:left;color:#000000;">Select a game mode above to begin</div>


<div class="layout">
    <!-- LEFT PANEL -->
    <div class="left-panel">
        <!-- Instructions removed -->

        <div class="car-wrapper">
            <img src="car.png" alt="Car with license plate" class="car-image">
            <div id="plate" class="plate-text">---</div>
        </div>

        <div id="difficultyLabel" class="difficulty diff-med" style="display:none;">
            Difficulty: ‚Äî
        </div>
        <div id="viableCountLabel" style="color:#6b7280; font-size:0.9rem; margin-top:2px;">
        </div>

        <div class="controls">
            <button id="startButton">Play again</button>
            <input id="wordInput" type="text" placeholder="Type a word" autocomplete="off" disabled>
            <button id="checkButton">Check</button>
            <button id="skipButton">Skip</button>
            <button id="endButton">End game</button>
        </div>

        <div id="result"></div>
        <button id="chartButton">View run chart</button>

        <div id="debug" style="color:#9ca3af;font-size:0.9rem;margin-top:10px;">Loading game data...</div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="game-status-panel" class="right-panel" style="display:none;">
        <div id="challenging-player-indicator" style="align-items:center;justify-content:space-between;display:none;margin-bottom:.5em;">
            <span id="challenging-player-text" style="font-weight:bold;"></span>
            <button id="challenging-player-cancel-button" onclick="cancelPendingChallenge(true)" style="padding:.25em .5em;">Cancel</button>
        </div>
        <div id="timerRow">
            <span id="timerDisplay">Time: 0.0 s</span>
            <span id="progressDisplay">Solved: 0 / 10</span>
        </div>

        <h2>Solved Plates</h2>
        <table>
            <thead>
            <tr>
                <th>Plate</th>
                <th>Word / Penalty</th>
                <th>Time</th>
                <th>Difficulty</th>
            </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
        <div id="historyEmpty" class="history-empty">
            No solved plates yet.
        </div>
    </div>

    <div id="h2h-panel" class="right-panel" style="display:none;">
        <!-- Create Challenge Buttons -->
        <div style="margin-bottom:1em;display:flex;gap:1em;flex-wrap:wrap;justify-content:center;">
            <button id="createChallengeBtn" style="font-size:1rem;background:#9370db;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                ‚öîÔ∏è Challenge a Player
            </button>
            <button id="createOpenChallengeBtn" style="font-size:1rem;background:#10b981;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                üåê Create Open Challenge
            </button>
        </div>
        
        <div style="max-height:800px;overflow-y:scroll">
            <!-- Incoming Challenges -->
            <div style="margin-bottom:30px;">
                <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:1.1rem;">üì• Incoming Challenges</h3>
                <div id="incomingChallenges" style="background:white;border-radius:8px;padding:16px;">
                    <p style="color:#9ca3af;text-align:center;">No incoming challenges</p>
                </div>
            </div>
            
            <!-- Outgoing Challenges -->
            <div style="margin-bottom:30px;">
                <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:1.1rem;">üì§ Outgoing Challenges</h3>
                <div id="outgoingChallenges" style="background:white;border-radius:8px;padding:16px;">
                    <p style="color:#9ca3af;text-align:center;">No outgoing challenges</p>
                </div>
            </div>
            
            <!-- Completed Challenges / Results -->
            <div style="margin-bottom:30px;">
                <h3 style="margin:0 0 12px 0;color:#1f2937;font-size:1.1rem;">üèÜ Challenge Results</h3>
                <div id="h2hResults" style="background:white;border-radius:8px;padding:16px;min-height:100px;overflow-x:auto;">
                    <p style="color:#9ca3af;text-align:center;">No completed challenges</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Viable words for a plate -->
<div id="wordsModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="wordsModalTitle">Plate: ---</div>
            <button class="modal-close-btn" id="wordsModalCloseBtn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="wordsModalStatus" style="margin-bottom:6px; color:#6b7280; font-size:0.9rem;">
                Loading...
            </div>
            <div id="wordsModalSortControls" class="words-sort-controls">
                <span class="words-sort-label">Sort:</span>
                <button id="wordsSortAlphaBtn" class="words-sort-button active">A‚ÄìZ</button>
                <button id="wordsSortLengthBtn" class="words-sort-button">Shortest ‚Üí longest</button>
            </div>
            <div id="wordsModalList" class="words-list"></div>
        </div>
        <div class="modal-footer">
            <button id="wordsModalCloseBtnBottom">Close</button>
        </div>
    </div>
</div>

<!-- MODAL: End-of-game chart -->
<div id="chartModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Run breakdown</div>
            <button class="modal-close-btn" id="chartModalCloseBtn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <canvas id="resultsChart"></canvas>
            <div style="margin-top:8px; font-size:0.85rem; color:#6b7280;">
                Blue = thinking time, red = skip penalty. Click a bar or point to see all viable words for that plate.
            </div>
        </div>
        <div class="modal-footer">
            <button id="chartModalCloseBtnBottom">Close</button>
        </div>
    </div>
</div>

<!-- Player Run Details Modal -->
<div id="runDetailsModalBackdrop" class="modal-backdrop" onclick="if(event.target.id==='runDetailsModalBackdrop')closeRunDetailsModal()">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="runDetailsModalTitle">Player's Run</div>
            <button class="modal-close-btn" onclick="closeRunDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="runDetailsContent"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closeRunDetailsModal()">Close</button>
        </div>
    </div>
</div>

<div style="margin-top:40px;padding:20px;background:#f9fafb;border-radius:8px;">
    <h2 style="margin-top:0;">üèÜ Daily Leaderboard</h2>
    <div style="margin-bottom:20px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="leaderboardDatePicker" style="font-weight:600;">Date:</label>
        <input type="date" id="leaderboardDatePicker" style="padding:8px;border:1px solid #d1d5db;border-radius:4px;">
        <button id="loadLeaderboardBtn" onclick="loadSelectedDate()" style="padding:8px 16px;cursor:pointer;">Load</button>
        <button id="todayLeaderboardBtn" onclick="loadTodayScores()" style="padding:8px 16px;cursor:pointer;">Today</button>
    </div>
    <div id="leaderboardDate" style="text-align:center;margin-bottom:16px;font-size:1.1rem;color:#6b7280;font-weight:600;"></div>
    <div id="leaderboardContent" style="background:white;padding:20px;border-radius:8px;min-height:200px;max-height:600px;overflow-y:auto;">
        <p style="text-align:center;color:#6b7280;">Click a button above to view scores</p>
    </div>
    
    <!-- Compare Runs Button -->
    <div id="compareRunsContainer" style="margin-top:20px;text-align:center;display:block;">
        <button id="compareRunsBtn" onclick="toggleCompareTable()" style="padding:12px 24px;font-size:1rem;background:#9370db;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
            Compare All Runs
        </button>
    </div>
    
    <!-- Comparison Table -->
    <div id="comparisonTableContainer" style="margin-top:20px;background:white;padding:20px;border-radius:8px;display:none;width:950px;">
        <h3 style="margin-top:0;">Run Comparison</h3>
        <div id="comparisonTable"></div>
    </div>
</div>


<!-- MODAL: Rules -->
<div id="rulesModalBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header" style="background:#9370db;">
            <div class="modal-title">How to Play</div>
            <button class="modal-close-btn" id="rulesModalCloseBtn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Objective -->
            <div style="margin-bottom:20px;">
                <div style="font-size:18px;font-weight:600;margin-bottom:16px;color:#1f2937;">Objective</div>
                <ul style="font-size:15px;line-height:1.8;color:#4b5563;margin:0;padding-left:20px;">
                    <li>Solve <strong>10 plates</strong> as fast as you can</li>
                    <li>To solve a plate, enter a word that contains the license plate letters <strong>in order</strong> (but not necessarily consecutively)</li>
                    <li>You can press <strong>Skip</strong>, but it adds a time penalty: +5s, then +10s, +15s, etc.</li>
                </ul>
            </div>
            
            <div style="height:1px;background:#e5e7eb;margin:16px 0;"></div>
            
            <!-- Examples -->
            <div style="margin-bottom:20px;">
                <div style="font-size:18px;font-weight:600;margin-bottom:16px;color:#1f2937;">Examples</div>
                
                <!-- Plate visual outside the examples -->
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="background:white;border:3px solid #374151;border-radius:6px;padding:12px 20px;display:inline-block;font-size:32px;font-weight:900;letter-spacing:4px;font-family:'Courier New',monospace;">RSE</div>
                </div>
                
                <div style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:26px;font-weight:600;margin-bottom:6px;letter-spacing:1px;">
                        <span style="color:#16a34a;font-weight:800;">r</span><span style="color:#1f2937;">i</span><span style="color:#16a34a;font-weight:800;">s</span><span style="color:#16a34a;font-weight:800;">e</span>
                    </div>
                    <div style="font-size:13px;color:#6b7280;font-style:italic;">R, then S, then E ‚úì</div>
                </div>
                
                <div style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:26px;font-weight:600;margin-bottom:6px;letter-spacing:1px;">
                        <span style="color:#1f2937;">coa</span><span style="color:#16a34a;font-weight:800;">r</span><span style="color:#16a34a;font-weight:800;">s</span><span style="color:#16a34a;font-weight:800;">e</span>
                    </div>
                    <div style="font-size:13px;color:#6b7280;font-style:italic;">R, then S, then E (letters don't need to be consecutive) ‚úì</div>
                </div>
                
                <div style="background:#f0fdf4;border:2px solid #86efac;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:26px;font-weight:600;margin-bottom:6px;letter-spacing:1px;">
                        <span style="color:#1f2937;">b</span><span style="color:#16a34a;font-weight:800;">r</span><span style="color:#1f2937;">i</span><span style="color:#16a34a;font-weight:800;">s</span><span style="color:#1f2937;">k</span><span style="color:#16a34a;font-weight:800;">e</span><span style="color:#1f2937;">t</span>
                    </div>
                    <div style="font-size:13px;color:#6b7280;font-style:italic;">R appears first, then S, then E (can have letters in between) ‚úì</div>
                </div>
            </div>
            
            <div style="height:1px;background:#e5e7eb;margin:16px 0;"></div>
                
                <div style="background:#fef2f2;border:2px solid #fca5a5;border-radius:8px;padding:12px;margin-bottom:10px;">
                    <div style="font-size:26px;font-weight:600;margin-bottom:6px;letter-spacing:1px;">
                        <span style="color:#dc2626;font-weight:800;">s</span><span style="color:#1f2937;">u</span><span style="color:#16a34a;font-weight:800;">r</span><span style="color:#1f2937;">mi</span><span style="color:#16a34a;font-weight:800;">s</span><span style="color:#16a34a;font-weight:800;">e</span>
                    </div>
                    <div style="font-size:13px;color:#6b7280;font-style:italic;">
                        First S comes BEFORE the R - wrong order! ‚úó
                    </div>
                </div>
            </div>

            
            <button id="rulesModalCloseBtnBottom" style="width:100%;padding:14px;background:#9370db;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;margin-top:24px;">Got it!</button>
        </div>
    </div>
</div>

<!-- MODAL: Select Opponent for H2H Challenge -->
<div id="opponentModalBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header" style="background:#9370db;">
            <div class="modal-title">Select Opponent</div>
            <button class="modal-close-btn" id="opponentModalCloseBtn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <input 
                type="text" 
                id="opponentSearchInput" 
                placeholder="Search by name..." 
                style="width:100%;padding:10px;margin-bottom:16px;border:2px solid #e5e7eb;border-radius:6px;font-size:15px;box-sizing:border-box;"
            />
            <div id="opponentList" style="max-height:300px;overflow-y:auto;">
                <!-- User list will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- MODAL: H2H Challenge Comparison -->
<div id="h2hComparisonModalBackdrop" class="modal-backdrop">
    <div class="modal" style="max-width:650px;">
        <div class="modal-header" style="background:#9370db;">
            <div class="modal-title" id="h2hComparisonTitle">H2H Challenge</div>
            <button class="modal-close-btn" id="h2hComparisonCloseBtn" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body" style="padding:20px;">
            <div id="h2hComparisonContent">
                <!-- Comparison table will be populated here -->
            </div>
        </div>
    </div>
</div>

</body>
</html>
