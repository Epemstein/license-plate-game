<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>License Plate Game v3</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 0 16px;
            line-height: 1.5;
        }

        h1 {
            text-align: center;
        }

        .plate-box {
            font-size: 2.5rem;
            letter-spacing: 0.4rem;
            text-align: center;
            border: 2px solid #333;
            padding: 16px;
            border-radius: 8px;
            margin: 24px 0;
            display: inline-block;
        }

        .plate-wrapper {
            text-align: center;
        }

        .controls {
            margin-top: 24px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls input[type="text"] {
            flex: 1;
            min-width: 180px;
            padding: 8px;
            font-size: 1rem;
        }

        button {
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
        }

        #result {
            margin-top: 16px;
            font-weight: bold;
        }

        #debug {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>License Plate Game v3</h1>

    <p>
        The plate letters must appear in your word in this order (not necessarily consecutively).<br>
        If a later plate letter appears before an earlier one (like <strong>spams</strong> for PMS), it’s invalid.
    </p>

    <div class="plate-wrapper">
        <div class="plate-box" id="plate">---</div>
    </div>

    <div class="controls">
        <input id="wordInput" type="text" placeholder="Type a word (e.g., promise)">
        <button id="checkButton">Check word</button>
        <button id="newPlateButton">New plate</button>
    </div>

    <div id="result"></div>
    <div id="debug"></div>

    <script>
        // ===== 1. Globals =====
        let WORDS = [];
        let DICTIONARY = new Set();
        let plateToExampleWord = {};
        let allPlates = [];
        let dictionaryReady = false;
        let currentPlate = null;

        // ===== 2. Core plate-matching logic =====
        function wordMatchesPlate(plate, word) {
            plate = plate.toUpperCase();
            word = word.toUpperCase();

            let expectedPlateIndex = 0; // which plate letter we're expecting next

            for (let i = 0; i < word.length; i++) {
                const ch = word[i];

                // Is this character one of the plate letters?
                const posInPlate = plate.indexOf(ch);

                if (posInPlate === -1) {
                    // Not in the plate at all -> ignore it
                    continue;
                }

                if (posInPlate === expectedPlateIndex) {
                    // We saw exactly the letter we were waiting for (e.g. P, then M, then S)
                    expectedPlateIndex++;

                    // If we've matched all plate letters in order, it's a valid word
                    if (expectedPlateIndex === plate.length) {
                        return true;
                    }
                } else if (posInPlate > expectedPlateIndex) {
                    // We saw a *later* plate letter before an earlier one.
                    // Example: plate PMS, word "spams":
                    // The first S appears before we've ever seen P -> invalid.
                    return false;
                } else {
                    // posInPlate < expectedPlateIndex:
                    // We've already passed this plate letter (e.g., another P after we've moved on to M).
                    // That’s fine; just ignore it.
                    continue;
                }
            }

            // If we finish the loop without matching all plate letters, it's not valid
            return false;
        }

        // ===== 3. Build plate map from WORDS =====
        function buildPlateMap() {
            plateToExampleWord = {};

            WORDS.forEach((word) => {
                const upper = word.toUpperCase();
                const len = upper.length;

                for (let i = 0; i < len; i++) {
                    for (let j = i + 1; j < len; j++) {
                        for (let k = j + 1; k < len; k++) {
                            const a = upper[i];
                            const b = upper[j];
                            const c = upper[k];

                            // Skip if any letters repeat (no AAB, etc.)
                            if (a === b || a === c || b === c) continue;

                            const plate = a + b + c;

                            if (!plateToExampleWord[plate]) {
                                if (wordMatchesPlate(plate, upper)) {
                                    plateToExampleWord[plate] = word;
                                }
                            }
                        }
                    }
                }
            });

            allPlates = Object.keys(plateToExampleWord);
            console.log("Built plates:", allPlates.length);
        }

        // ===== 4. DOM references =====
        const plateEl = document.getElementById("plate");
        const wordInputEl = document.getElementById("wordInput");
        const resultEl = document.getElementById("result");
        const debugEl = document.getElementById("debug");
        const checkButtonEl = document.getElementById("checkButton");
        const newPlateButtonEl = document.getElementById("newPlateButton");

        // ===== 5. Dictionary loading =====
        async function loadDictionary() {
            try {
                const response = await fetch("words.txt");
                if (!response.ok) {
                    throw new Error("Failed to load words.txt: " + response.status);
                }

                const text = await response.text();
                const lines = text.split(/\r?\n/);

                WORDS = [];
                DICTIONARY = new Set();

                for (const line of lines) {
                    const w = line.trim().toLowerCase();
                    if (!w) continue;
                    if (!/^[a-z]+$/.test(w)) continue;
                    if (w.length < 3) continue;

                    WORDS.push(w);
                    DICTIONARY.add(w.toUpperCase());
                }

                buildPlateMap();
                dictionaryReady = true;

                debugEl.textContent = `Loaded ${WORDS.length} words, ${allPlates.length} plates.`;
                pickRandomPlate();
            } catch (err) {
                console.error("Error loading dictionary:", err);
                resultEl.textContent = "Error loading dictionary. Check console / words.txt.";
                resultEl.style.color = "red";
            }
        }

        // ===== 6. Game functions =====
        function pickRandomPlate() {
            if (!dictionaryReady) {
                resultEl.textContent = "Dictionary not loaded yet.";
                resultEl.style.color = "red";
                return;
            }

            if (allPlates.length === 0) {
                plateEl.textContent = "ERR";
                resultEl.textContent = "No plates available. Check words.txt.";
                resultEl.style.color = "red";
                return;
            }

            const index = Math.floor(Math.random() * allPlates.length);
            currentPlate = allPlates[index];
            plateEl.textContent = currentPlate;
            resultEl.textContent = "";
            wordInputEl.value = "";
            wordInputEl.focus();
        }

        function checkWord() {
            const rawWord = wordInputEl.value.trim();

            if (!rawWord) {
                resultEl.textContent = "Please type a word first.";
                resultEl.style.color = "red";
                return;
            }

            if (!/^[a-zA-Z]+$/.test(rawWord)) {
                resultEl.textContent = "Please use letters only (A–Z).";
                resultEl.style.color = "red";
                return;
            }

            if (!dictionaryReady) {
                resultEl.textContent = "Dictionary still loading. Try again in a moment.";
                resultEl.style.color = "red";
                return;
            }

            if (!currentPlate) {
                resultEl.textContent = "No plate yet. Click 'New plate'.";
                resultEl.style.color = "red";
                return;
            }

            const upperWord = rawWord.toUpperCase();

            if (!DICTIONARY.has(upperWord)) {
                resultEl.textContent = `❌ "${rawWord}" is not in my dictionary.`;
                resultEl.style.color = "red";
                return;
            }

            const isMatch = wordMatchesPlate(currentPlate, upperWord);

            if (isMatch) {
                resultEl.textContent = `✅ "${rawWord}" is a valid dictionary word for plate ${currentPlate}.`;
                resultEl.style.color = "green";
            } else {
                resultEl.textContent = `❌ "${rawWord}" is in the dictionary but does NOT match plate ${currentPlate} in the correct order.`;
                resultEl.style.color = "red";
            }
        }

        // ===== 7. Hook up events and start =====
        checkButtonEl.addEventListener("click", checkWord);

        wordInputEl.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                checkWord();
            }
        });

        newPlateButtonEl.addEventListener("click", function () {
            pickRandomPlate();
        });

        // Kick off dictionary loading
        loadDictionary();
    </script>
</body>
</html>
